<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è | –Ñ–≤—Ä–æ–∫–æ–¥</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-tasks"></i>
            </div>
            <h2>–î–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h2>
        </div>
        
        <div class="nav-links">
            <a href="technician-dashboard.html">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥
            </a>
            <a href="#" id="refreshBtn">
                <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏
            </a>
        </div>
    </nav>

    <div class="container">
        <h1 style="color: #1a5faa; margin-bottom: 0.5rem;">
            <i class="fas fa-hand-paper"></i> –î–æ—Å—Ç—É–ø–Ω—ñ –¥–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–≤–¥–∞–Ω–Ω—è
        </h1>
        <p style="color: #666; margin-bottom: 2rem;">
            –û–±–µ—Ä—ñ—Ç—å –∑–∞–≤–¥–∞–Ω–Ω—è, —è–∫–µ –≤–∏ —Ö–æ—á–µ—Ç–µ –≤–∑—è—Ç–∏ –Ω–∞ —Å–µ–±–µ
        </p>
        
        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="tech-stats" style="margin-bottom: 2rem;">
            <div style="background: #e8f4fc; padding: 1rem; border-radius: 10px; text-align: center;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #2c3e50;">–î–æ—Å—Ç—É–ø–Ω—ñ –∑–∞—Ä–∞–∑</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #1a5faa;" id="availableCount">0</div>
            </div>
            
            <div style="background: #f0f7ff; padding: 1rem; border-radius: 10px; text-align: center;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #2c3e50;">–í–∞—à—ñ –∞–∫—Ç–∏–≤–Ω—ñ</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #3498db;" id="myActiveCount">0</div>
            </div>
            
            <div style="background: #f8fafc; padding: 1rem; border-radius: 10px; text-align: center;">
                <h3 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #2c3e50;">–£—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è</h3>
                <div style="font-size: 2rem; font-weight: bold; color: #2c3e50;" id="totalCount">0</div>
            </div>
        </div>
        
        <!-- –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ–π–Ω–∏–π –±–ª–æ–∫ -->
        <div class="card" style="background: #f0f7ff; margin-bottom: 2rem;">
            <h3 style="color: #1a5faa; margin-bottom: 0.5rem;">
                <i class="fas fa-info-circle"></i> –Ø–∫ –ø—Ä–∞—Ü—é—î —Å–∏—Å—Ç–µ–º–∞
            </h3>
            <ul style="margin: 0; padding-left: 1.5rem; color: #2c3e50;">
                <li>–¢—É—Ç –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –∑–∞–≤–¥–∞–Ω–Ω—è, —è–∫—ñ —â–µ –Ω–µ –º–∞—é—Ç—å –ø—Ä–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ —Ç–µ—Ö–Ω—ñ–∫–∞</li>
                <li>–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è" —â–æ–± –≤–∑—è—Ç–∏ –π–æ–≥–æ –Ω–∞ —Å–µ–±–µ</li>
                <li>–ü—ñ—Å–ª—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑–∞–≤–¥–∞–Ω–Ω—è –∑'—è–≤–∏—Ç—å—Å—è —É –≤–∞—à–æ–º—É —Å–ø–∏—Å–∫—É –∞–∫—Ç–∏–≤–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å</li>
                <li>–í–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–∏–π–Ω—è—Ç–∏ –æ–¥—Ä–∞–∑—É –¥–µ–∫—ñ–ª—å–∫–∞ –∑–∞–≤–¥–∞–Ω—å</li>
                <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥</li>
            </ul>
        </div>
        
        <!-- –°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å -->
        <div id="availableTasksContainer">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å...</p>
            </div>
        </div>
        
        <!-- –Ø–∫—â–æ –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å -->
        <div id="noTasksMessage" class="card" style="display: none; text-align: center;">
            <i class="fas fa-check-circle fa-3x" style="color: #2ecc71; margin-bottom: 1rem;"></i>
            <h3 style="color: #2c3e50;">–ù–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å</h3>
            <p style="color: #666; margin-bottom: 1.5rem;">
                –í—Å—ñ –∑–∞–≤–¥–∞–Ω–Ω—è –≤–∂–µ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω—ñ –º—ñ–∂ —Ç–µ—Ö–Ω—ñ–∫–∞–º–∏.<br>
                –°–ø—Ä–æ–±—É–π—Ç–µ –æ–Ω–æ–≤–∏—Ç–∏ —Å—Ç–æ—Ä—ñ–Ω–∫—É –∞–±–æ —Å—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤—É –∑–∞—è–≤–∫—É.
            </p>
            <div style="display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="window.location.href='create-request.html'">
                    <i class="fas fa-plus"></i> –°—Ç–≤–æ—Ä–∏—Ç–∏ –∑–∞—è–≤–∫—É
                </button>
                <button class="btn btn-outline" onclick="refreshTasks()">
                    <i class="fas fa-sync-alt"></i> –û–Ω–æ–≤–∏—Ç–∏
                </button>
            </div>
        </div>
    </div>
    
    <script src="script.js"></script>
    
    <script>
        // –ü–æ—Ç–æ—á–Ω–∏–π —Ç–µ—Ö–Ω—ñ–∫
        let currentTechnician = null;
        
        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
        document.addEventListener('DOMContentLoaded', async function() {
            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó
            const technician = JSON.parse(localStorage.getItem('technician'));
            if (!technician) {
                window.location.href = 'login.html';
                return;
            }
            
            currentTechnician = technician;
            
            // –ù–∞–ª–∞—à—Ç–æ–≤—É—î–º–æ –∫–Ω–æ–ø–∫—É –æ–Ω–æ–≤–ª–µ–Ω–Ω—è
            document.getElementById('refreshBtn').addEventListener('click', refreshTasks);
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è
            await loadAvailableTasks();
            
            // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–µ—Ö–Ω—ñ–∫–∞
            await loadTechnicianStats();
            
            // –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ–∂–Ω—ñ 30 —Å–µ–∫—É–Ω–¥
            setInterval(async () => {
                await loadAvailableTasks();
                await loadTechnicianStats();
            }, 30000);
        });
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å
        async function loadAvailableTasks() {
            try {
                const response = await fetch('http://localhost:5000/api/tasks/available');
                if (!response.ok) throw new Error('API –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î');
                
                const tasks = await response.json();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫
                document.getElementById('availableCount').textContent = tasks.length;
                
                // –ü–æ–∫–∞–∑—É—î–º–æ/–ø—Ä–∏—Ö–æ–≤—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –∑–∞–≤–¥–∞–Ω—å
                const noTasksMessage = document.getElementById('noTasksMessage');
                const container = document.getElementById('availableTasksContainer');
                
                if (tasks.length === 0) {
                    container.style.display = 'none';
                    noTasksMessage.style.display = 'block';
                } else {
                    container.style.display = 'block';
                    noTasksMessage.style.display = 'none';
                    
                    // –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è
                    displayAvailableTasks(tasks);
                }
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å:', error);
                
                // –î–µ–º–æ-–¥–∞–Ω—ñ
                const demoTasks = getDemoAvailableTasks();
                document.getElementById('availableCount').textContent = demoTasks.length;
                displayAvailableTasks(demoTasks);
            }
        }
        
        // –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ—Ö–Ω—ñ–∫–∞
        async function loadTechnicianStats() {
            if (!currentTechnician) return;
            
            try {
                const response = await fetch(`${API_URL}/technician/${currentTechnician.id}/tasks`);
                if (!response.ok) throw new Error('API –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î');
                
                const data = await response.json();
                
                // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                document.getElementById('myActiveCount').textContent = data.stats.active || 0;
                document.getElementById('totalCount').textContent = 
                    (data.stats.active || 0) + (data.stats.completed || 0) + (data.stats.available || 0);
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
                
                // –î–µ–º–æ-—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                document.getElementById('myActiveCount').textContent = '2';
                document.getElementById('totalCount').textContent = '15';
            }
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–≤–¥–∞–Ω—å
        async function refreshTasks() {
            const refreshBtn = document.getElementById('refreshBtn');
            const originalHtml = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;
            
            await Promise.all([
                loadAvailableTasks(),
                loadTechnicianStats()
            ]);
            
            refreshBtn.innerHTML = originalHtml;
            refreshBtn.disabled = false;
            
            showNotification('–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å –æ–Ω–æ–≤–ª–µ–Ω–æ', 'success');
        }
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å
        function displayAvailableTasks(tasks) {
            const container = document.getElementById('availableTasksContainer');
            if (!container) return;
            
            let html = '';
            
            tasks.forEach(task => {
                // –í–∏–∑–Ω–∞—á–∞—î–º–æ –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç
                let priorityBadge = '';
                if (task.priority === 'high') {
                    priorityBadge = '<span class="status-badge" style="background: #fde8e8; color: #e74c3c; margin-left: 0.5rem;">–í–∏—Å–æ–∫–∏–π</span>';
                } else if (task.priority === 'urgent') {
                    priorityBadge = '<span class="status-badge" style="background: #fde8e8; color: #e74c3c; margin-left: 0.5rem;">üî• –¢–µ—Ä–º—ñ–Ω–æ–≤–∏–π</span>';
                }
                
                // –í–∏–∑–Ω–∞—á–∞—î–º–æ —Ç–∏–ø –ø—Ä–∏—Å—Ç—Ä–æ—é
                const deviceType = task.device_type || '–ö–∞—Å–æ–≤–∏–π –∞–ø–∞—Ä–∞—Ç';
                const deviceIcon = deviceType.includes('–∫–∞—Å') ? 'fa-cash-register' : 
                                 deviceType.includes('—Ñ—ñ—Å') ? 'fa-receipt' : 'fa-laptop';
                
                html += `
                <div class="task-card" data-task-id="${task.id}">
                    <div class="task-header">
                        <div>
                            <h3 style="margin: 0 0 0.5rem 0;">
                                –ó–∞–≤–¥–∞–Ω–Ω—è #${task.id}
                                ${priorityBadge}
                            </h3>
                            <p style="margin: 0; color: #666; font-size: 0.9rem;">
                                <i class="fas fa-building"></i> ${task.company_name || '–ö–ª—ñ—î–Ω—Ç'}
                            </p>
                        </div>
                        <span class="status-badge status-new">–î–æ—Å—Ç—É–ø–Ω–µ</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin: 1rem 0;">
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong><i class="fas ${deviceIcon}"></i> –ü—Ä–∏—Å—Ç—Ä—ñ–π:</strong></p>
                            <p style="margin: 0; color: #666;">${task.model || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                            ${task.serial_number ? `<small style="color: #999;">${task.serial_number}</small>` : ''}
                        </div>
                        
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong><i class="fas fa-map-marker-alt"></i> –ê–¥—Ä–µ—Å–∞:</strong></p>
                            <p style="margin: 0; color: #666;">${task.address || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                        </div>
                        
                        <div>
                            <p style="margin: 0 0 0.5rem 0;"><strong><i class="fas fa-phone"></i> –ö–æ–Ω—Ç–∞–∫—Ç–∏:</strong></p>
                            <p style="margin: 0; color: #666;">${task.contact_phone || '–ù–µ –≤–∫–∞–∑–∞–Ω–æ'}</p>
                        </div>
                    </div>
                    
                    <p style="margin: 1rem 0;"><strong><i class="fas fa-file-alt"></i> –û–ø–∏—Å –ø—Ä–æ–±–ª–µ–º–∏:</strong></p>
                    <p style="color: #666; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin: 0;">
                        ${task.description || '–ë–µ–∑ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ–ø–∏—Å—É'}
                    </p>
                    
                    <div class="task-actions">
                        <button class="btn btn-primary" onclick="takeAvailableTask(${task.id})">
                            <i class="fas fa-hand-paper"></i> –ü—Ä–∏–π–Ω—è—Ç–∏ –∑–∞–≤–¥–∞–Ω–Ω—è
                        </button>
                        
                        <button class="btn btn-outline" onclick="viewTaskDetails(${task.id})">
                            <i class="fas fa-info-circle"></i> –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ
                        </button>
                        
                        ${task.contact_phone && task.contact_phone !== '–ù–µ –≤–∫–∞–∑–∞–Ω–æ' ? `
                        <button class="btn btn-outline" onclick="callClient('${task.contact_phone}')">
                            <i class="fas fa-phone"></i> –ó–∞—Ç–µ–ª–µ—Ñ–æ–Ω—É–≤–∞—Ç–∏
                        </button>
                        ` : ''}
                    </div>
                </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // –î–µ–º–æ-–¥–∞–Ω—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å
        function getDemoAvailableTasks() {
            return [
                {
                    id: 1025,
                    company_name: '–¢–û–í ¬´–Ñ–≤—Ä–æ–∫–æ–¥¬ª',
                    address: '–º. –ö–∏—ó–≤, –≤—É–ª. –¢–µ—Å—Ç–æ–≤–∞, 1',
                    contact_phone: '+380501234567',
                    model: '–ê–¢–û–õ 90F',
                    serial_number: 'KAS-2024-003',
                    device_type: '–ö–∞—Å–æ–≤–∏–π –∞–ø–∞—Ä–∞—Ç',
                    description: '–ü–æ–≤—ñ—Ä–∫–∞ –∫–∞—Å–æ–≤–æ–≥–æ –∞–ø–∞—Ä–∞—Ç–∞, –∫–∞–ª—ñ–±—Ä–æ–≤–∫–∞ –≤–∞–≥, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ —á–µ–∫–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ç–µ—Ä–∞',
                    priority: 'normal',
                    created_at: '2024-12-10T10:30:00'
                },
                {
                    id: 1027,
                    company_name: '–ú–∞–≥–∞–∑–∏–Ω ¬´–ï–ª–µ–∫—Ç—Ä–æ–Ω—ñ–∫–∞¬ª',
                    address: '–º. –ö–∏—ó–≤, –≤—É–ª. –¢–µ—Ö–Ω—ñ—á–Ω–∞, 8',
                    contact_phone: '+380501112233',
                    model: 'MINI MARKET MM-300',
                    serial_number: 'KAS-2024-005',
                    device_type: '–ö–∞—Å–æ–≤–∏–π –∞–ø–∞—Ä–∞—Ç',
                    description: '–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ 1–°, –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è —Ç–æ–≤–∞—Ä–Ω–æ—ó –±–∞–∑–∏',
                    priority: 'high',
                    created_at: '2024-12-10T09:15:00'
                },
                {
                    id: 1028,
                    company_name: '–ö–∞–≤\'—è—Ä–Ω—è ¬´–ê—Ä–æ–º–∞—Ç¬ª',
                    address: '–º. –ö–∏—ó–≤, –≤—É–ª. –ö–∞–≤–æ–≤–∞, 12',
                    contact_phone: '+380632223344',
                    model: 'RICH 1800K',
                    serial_number: 'FIS-2024-006',
                    device_type: '–§—ñ—Å–∫–∞–ª—å–Ω–∏–π —Ä–µ—î—Å—Ç—Ä–∞—Ç–æ—Ä',
                    description: '–ó–∞–º—ñ–Ω–∞ —Ç–µ—Ä–º–æ–ø–∞–ø–µ—Ä—É, —á–∏—Å—Ç–∫–∞ –º–µ—Ö–∞–Ω—ñ–∑–º—ñ–≤, –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑\'—î–¥–Ω–∞–Ω—å',
                    priority: 'normal',
                    created_at: '2024-12-09T16:45:00'
                }
            ];
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        window.refreshTasks = refreshTasks;
    </script>
</body>
</html>